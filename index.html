<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoPet - Crear Tarjeta NFC para Mascota</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="images/logo.png">
</head>
<body>
    <div class="container">
        <header>
            <img src="images/logo.png" alt="Logo InfoPet" class="logo">
            <h1>InfoPet</h1>
            <p class="subtitle">Crea tarjetas NFC para tus mascotas</p>
        </header>

        <main>
            <section class="form-section">
                <h2>Datos de la Mascota</h2>
                <form id="petForm">
                    <div class="form-group">
                        <label for="petName">Nombre de la mascota *</label>
                        <input type="text" id="petName" required placeholder="Ej: Max">
                    </div>

                    <div class="form-group">
                        <label for="petType">Tipo de mascota *</label>
                        <select id="petType" required>
                            <option value="">Seleccione...</option>
                            <option value="perro">Perro</option>
                            <option value="gato">Gato</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="petBreed">Raza</label>
                        <input type="text" id="petBreed" placeholder="Ej: Labrador">
                    </div>

                    <div class="form-group">
                        <label for="petAge">Edad (a√±os)</label>
                        <input type="number" id="petAge" min="0" max="30" placeholder="Ej: 5">
                    </div>

                    <div class="form-group">
                        <label for="petPhoto">Foto de la mascota</label>
                        <div class="file-upload">
                            <input type="file" id="petPhoto" accept="image/*">
                            <label for="petPhoto">Seleccionar imagen</label>
                            <span id="fileName">No se ha seleccionado ninguna imagen</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ownerName">Nombre del due√±o *</label>
                        <input type="text" id="ownerName" required placeholder="Tu nombre">
                    </div>

                    <div class="form-group">
                        <label for="ownerPhone">Tel√©fono de contacto *</label>
                        <input type="tel" id="ownerPhone" required placeholder="+34 600 000 000">
                    </div>

                    <div class="form-group">
                        <label for="medicalInfo">Informaci√≥n m√©dica importante</label>
                        <textarea id="medicalInfo" rows="4" placeholder="Alergias, medicaci√≥n, etc."></textarea>
                    </div>

                    <button type="button" id="generateBtn" class="btn primary-btn">
                        <span class="btn-icon">üîÑ</span> Generar Tarjeta NFC
                    </button>
                </form>
            </section>

            <section id="previewSection" class="preview-section" style="display: none;">
                <h2>Previsualizaci√≥n de la Tarjeta</h2>
                <div class="card-preview">
                    <div class="card-header">
                        <img id="previewImage" src="" alt="Foto de la mascota" class="pet-image">
                        <div class="pet-info">
                            <h3 id="previewName"></h3>
                            <p id="previewBreedAge"></p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="info-label">Due√±o:</span>
                            <span id="previewOwner"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Contacto:</span>
                            <span id="previewPhone"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Info M√©dica:</span>
                            <span id="previewMedical"></span>
                        </div>
                    </div>
                </div>

                <div class="nfc-write-section">
                    <button id="writeNfcBtn" class="btn success-btn">
                        <span class="btn-icon">üì≤</span> Grabar en Chip NFC
                    </button>
                    <div id="nfcStatus" class="status-message"></div>
                </div>
            </section>
        </main>

        <footer>
            <p>¬© 2023 InfoPet - Todos los derechos reservados</p>
        </footer>
    </div>

    <script src="assets/js/image-compressor.js"></script>
    <script src="assets/js/nfc-handler.js"></script>
    <script>
        // Inicializaci√≥n del formulario
        document.getElementById('petPhoto').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'No se ha seleccionado ninguna imagen';
            document.getElementById('fileName').textContent = fileName;
        });

        // Manejo del bot√≥n Generar
        document.getElementById('generateBtn').addEventListener('click', async function() {
            // Validar formulario
            const requiredFields = ['petName', 'petType', 'ownerName', 'ownerPhone'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            if (!isValid) {
                alert('Por favor complete todos los campos requeridos (*)');
                return;
            }

            // Comprimir imagen si existe
            let compressedImage = '';
            const photoInput = document.getElementById('petPhoto');
            if (photoInput.files[0]) {
                try {
                    compressedImage = await compressImage(photoInput.files[0]);
                    document.getElementById('previewImage').src = compressedImage;
                } catch (error) {
                    console.error('Error al comprimir imagen:', error);
                    compressedImage = '';
                }
            }

            // Crear objeto con los datos
            window.petData = {
                name: document.getElementById('petName').value,
                type: document.getElementById('petType').value,
                breed: document.getElementById('petBreed').value,
                age: document.getElementById('petAge').value,
                owner: document.getElementById('ownerName').value,
                phone: document.getElementById('ownerPhone').value,
                medical: document.getElementById('medicalInfo').value,
                image: compressedImage,
                timestamp: new Date().toISOString()
            };

            // Mostrar previsualizaci√≥n
            document.getElementById('previewName').textContent = window.petData.name;
            document.getElementById('previewBreedAge').textContent = 
                `${window.petData.breed || 'Sin raza especificada'} ‚Ä¢ ${window.petData.age || '?'} a√±os`;
            document.getElementById('previewOwner').textContent = window.petData.owner;
            document.getElementById('previewPhone').textContent = window.petData.phone;
            document.getElementById('previewMedical').textContent = window.petData.medical || 'Ninguna';

            document.getElementById('previewSection').style.display = 'block';
            window.scrollTo({
                top: document.getElementById('previewSection').offsetTop,
                behavior: 'smooth'
            });
        });

        // Manejo del bot√≥n Grabar NFC
        document.getElementById('writeNfcBtn').addEventListener('click', async function() {
            if (!window.petData) {
                alert('Primero genere los datos de la mascota');
                return;
            }

            const statusElement = document.getElementById('nfcStatus');
            statusElement.textContent = "Preparando para grabar en NFC...";
            statusElement.className = "status-message info";

            try {
                const success = await writeToNfc(window.petData);
                if (success) {
                    statusElement.textContent = "¬°Tarjeta grabada con √©xito!";
                    statusElement.className = "status-message success";
                } else {
                    statusElement.textContent = "Error al grabar la tarjeta NFC";
                    statusElement.className = "status-message error";
                }
            } catch (error) {
                statusElement.textContent = `Error: ${error.message}`;
                statusElement.className = "status-message error";
                console.error("Error al grabar NFC:", error);
            }
        });
    </script>
</body>
</html>
